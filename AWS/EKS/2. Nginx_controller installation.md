
## EKS needs two roles:
- you must create the EKS IAM roles before running aws eks create-cluster.

- 1. EKS Cluster Role (EKSClusterRole)

This role allows EKS to manage AWS resources on your behalf.

Create it with this command:

```
aws iam create-role \
  --role-name EKSClusterRole \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": { "Service": "eks.amazonaws.com" },
        "Action": "sts:AssumeRole"
      }
    ]
  }'

```

- Then attach the required policy:

  ```
  aws iam attach-role-policy \
  --role-name EKSClusterRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  ```

##  2. EKS Node Group Role (EKSNodeInstanceRole)

- This role allows EC2 nodes in the cluster to connect to EKS and other AWS services.

- Create it:
  
  ```
  aws iam create-role \
  --role-name EKSNodeInstanceRole \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": { "Service": "ec2.amazonaws.com" },
        "Action": "sts:AssumeRole"
      }
    ]
  }'

  ```

## 3.  Attach the required policies:

```
aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy

aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly

aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
```

## Steps to create Cluster:

- Command to create cluster:

```
aws eks create-cluster   --name budget-eks   --region us-east-1   --role-arn arn:aws:iam::438465168997:role/EKSClusterRole   --resources-vpc-config subnetIds=$SUBNET1_ID,$SUBNET2_ID,securityGroupIds=$CLUSTER_SG_ID
```

- Hereâ€™s the command (using 2 EC2 nodes with t3.small for budget):

```
 aws eks create-nodegroup   --cluster-name budget-eks   --nodegroup-name budget-ng   --scaling-config minSize=2,maxSize=2,desiredSize=2   --disk-size 20   --subnets $SUBNET1_ID $SUBNET2_ID   --instance-types t3.small   --ami-type AL2023_x86_64_STANDARD   --node-role arn:aws:iam::438465168997:role/EKSNodeInstanceRole   --region us-east-1
```

## 4.AWS Load Balancer Controller Setup on EKS

This document outlines the steps to install and configure the **AWS Load Balancer Controller** on an **EKS cluster**. The instructions include creating the necessary IAM policy, associating the IAM OIDC provider, and creating a service account.

---

## 5. Download the IAM Policy JSON

The AWS Load Balancer Controller requires a specific IAM policy. Download it using `curl`:

```bash
curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
```
## Explanation:
  -  -o iam_policy.json saves the file locally as iam_policy.json.
  -  The URL points to the official AWS Load Balancer Controller IAM policy.

## 6. Create the IAM Policy

- Use the downloaded JSON to create a new IAM policy in AWS:
```
aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json
```
## Explanation:

  -   policy-name specifies the name of the IAM policy.

  -   policy-document points to the local JSON file you downloaded.

- This policy allows the controller to manage AWS resources like load balancers.

##  7. Associate IAM OIDC Provider with EKS Cluster

- Before creating the service account, associate the IAM OIDC provider with your cluster:

```
eksctl utils associate-iam-oidc-provider \
    --region us-east-1 \
    --cluster budget-eks \
    --approve
```

## Explanation:

-  Enables IAM roles for service accounts.

-  --approve automatically applies the changes.

-  Required to let Kubernetes service accounts assume IAM roles.

## Kubeconfig command

```
aws eks update-kubeconfig \
  --region us-east-1 \
  --name budget-eks

```

## Namespace 
- Create name space for isolating the resources.
```
  kubectl create ns nginx-ingress-controller
  kubectl create ns alb-ingress-controller
  kubectl create ns nginx-app

```
`kubectl create ns nginx-ingress-controller` - for nginx -ingress controller
`kubectl create ns alb-ingress-controller`   - for alb ingress controller
`kubectl create ns nginx-app`                - for nginx-app

## 8. Create the IAM Service Account

- Create a Kubernetes service account with the IAM policy attached:

```
eksctl create iamserviceaccount \
    --cluster budget-eks \
    --namespace alb-ingress-controller \
    --name aws-load-balancer-controller \
    --attach-policy-arn arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve \
    --region us-east-1
```
## Explanation:

- --cluster specifies the EKS cluster name.

- --namespace sets the namespace in Kubernetes (kube-system recommended).

- --attach-policy-arn links the IAM policy to the service account.

- --approve applies the changes immediately.

`Note: The arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy should match your AWS account ID.`

## 9. Verify the Cluster OIDC Issuer

- To ensure the OIDC provider is correctly associated, describe the EKS cluster:

```
aws eks describe-cluster \
    --name budget-eks \
    --region us-east-1 \
    --query "cluster.identity.oidc.issuer" \
    --output text
```

## Explanation:

 - Returns the OIDC issuer URL for your cluster.

 - Useful for debugging and verifying IAM role associations.

## 10. Optional: Re-run Service Account Creation (if needed)

- If you need to recreate or update the service account, you can run the same command again:
```
eksctl create iamserviceaccount \
    --cluster budget-eks \
    --namespace alb-ingress-controller \
    --name aws-load-balancer-controller \
    --attach-policy-arn arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve \
    --region us-east-1
```

## 11. Installing alb-ingress controller

### command to install:
```
helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
    --namespace alb-ingress-controller \
    --set clusterName=budget-eks \
    --set serviceAccount.create=false \
    --set serviceAccount.name=aws-load-balancer-controller \
    --set region=us-east-1 \
    --set vpcId=$VPC_ID
```

### command to redeploy:
```
helm upgrade aws-load-balancer-controller eks/aws-load-balancer-controller \
    --namespace alb-ingress-controller \
    --set clusterName=budget-eks \
    --set serviceAccount.create=false \
    --set serviceAccount.name=aws-load-balancer-controller \
    --set region=us-east-1 \
    --set vpcId=$VPC_ID
```

## Verify Installation
```
kubectl get deployment -n alb-ingress-controller
kubectl get pods -n alb-ingress-controller
```


## We are creaing nginx web page using following file:

```
apiVersion: v1
kind: Namespace
metadata:
  name: nginx-app
---
# Deployment for Red NGINX App
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-red
  namespace: nginx-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-red
  template:
    metadata:
      labels:
        app: nginx-red
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: nginx-red-html
---
# ConfigMap for Red NGINX App
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-red-html
  namespace: nginx-app
data:
  index.html: |
    <html>
      <body style="background-color:red; text-align:center;">
        <h1>Red NGINX App</h1>
      </body>
    </html>
---
# Deployment for Blue NGINX App
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-blue
  namespace: nginx-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-blue
  template:
    metadata:
      labels:
        app: nginx-blue
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html
        configMap:
          name: nginx-blue-html
---
# ConfigMap for Blue NGINX App
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-blue-html
  namespace: nginx-app
data:
  index.html: |
    <html>
      <body style="background-color:blue; text-align:center;">
        <h1>Blue NGINX App</h1>
      </body>
    </html>
---
# Service for Red NGINX App
apiVersion: v1
kind: Service
metadata:
  name: nginx-red-service
  namespace: nginx-app
spec:
  selector:
    app: nginx-red
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: NodePort
---
# Service for Blue NGINX App
apiVersion: v1
kind: Service
metadata:
  name: nginx-blue-service
  namespace: nginx-app
spec:
  selector:
    app: nginx-blue
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: NodePort
```

## Creating ingress for ALB-ingress controller:

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: alb-to-nginx
  namespace: nginx-ingress-controller
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP":80}]'
    alb.ingress.kubernetes.io/group.name: nginx-app-group
spec:
  ingressClassName: alb
  rules:
  - host: nginx.getitworth.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-ingress-ingress-nginx-controller
            port:
              number: 80
```

## Creating ingress for nginx ingress controller:

The following file `nginx-ingress.yaml`

```
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nginx-ingress-routes
  namespace: nginx-app
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: nginx.getitworth.com
    http:
      paths:
      - path: /red
        pathType: Prefix
        backend:
          service:
            name: nginx-red-service
            port:
              number: 80
      - path: /blue
        pathType: Prefix
        backend:
          service:
            name: nginx-blue-service
            port:
              number: 80
```

## Steps to Associate ALB with Subdomain in Cloudflare

- Get your ALB DNS name

- From your output:
```
k8s-nginxappgroup-b5890cb278-833006252.us-east-1.elb.amazonaws.com
```

Thatâ€™s the DNS name of your AWS Load Balancer.

## Log in to Cloudflare Dashboard

- Go to your domain getitworth.com.

- Navigate to DNS â†’ Records.

## Create a CNAME record

- Click Add record.

- `Type`: CNAME

- `Name`: nginx
 
     - This makes the record `nginx.getitworth.com`.

- `Target`: paste your ALB DNS:

```
k8s-nginxappgroup-b5890cb278-833006252.us-east-1.elb.amazonaws.com
```

- Save the record.

##  Test

- Once DNS propagates (can be instant â†’ ~15 min, sometimes up to a few hours):

```
nslookup nginx.getitworth.com
```

## Should resolve to the ALB DNS â†’ which resolves to AWS IPs.

- Then test in browser:
```
http://nginx.getitworth.com/red
http://nginx.getitworth.com/blue
```
