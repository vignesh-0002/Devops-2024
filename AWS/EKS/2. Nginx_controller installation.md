
## EKS needs two roles:
- you must create the EKS IAM roles before running aws eks create-cluster.

- 1. EKS Cluster Role (EKSClusterRole)

This role allows EKS to manage AWS resources on your behalf.

Create it with this command:

```
aws iam create-role \
  --role-name EKSClusterRole \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": { "Service": "eks.amazonaws.com" },
        "Action": "sts:AssumeRole"
      }
    ]
  }'

```

- Then attach the required policy:

  ```
  aws iam attach-role-policy \
  --role-name EKSClusterRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
  ```

##  2. EKS Node Group Role (EKSNodeInstanceRole)

- This role allows EC2 nodes in the cluster to connect to EKS and other AWS services.

- Create it:
  
  ```
  aws iam create-role \
  --role-name EKSNodeInstanceRole \
  --assume-role-policy-document '{
    "Version": "2012-10-17",
    "Statement": [
      {
        "Effect": "Allow",
        "Principal": { "Service": "ec2.amazonaws.com" },
        "Action": "sts:AssumeRole"
      }
    ]
  }'

  ```

## 3.  Attach the required policies:

```
aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy

aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly

aws iam attach-role-policy \
  --role-name EKSNodeInstanceRole \
  --policy-arn arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
```

## Steps to create Cluster:

- Command to create cluster:

```
aws eks create-cluster \
  --name budget-eks \
  --region us-east-1 \
  --role-arn arn:aws:iam::438465168997:role/EKSClusterRole \
  --resources-vpc-config subnetIds=subnet-0393724a838283392,subnet-036ee587b6816bf88,securityGroupIds=sg-052e7d0982f25afcb

```

- Hereâ€™s the command (using 2 EC2 nodes with t3.small for budget):

```
aws eks create-nodegroup \
  --cluster-name budget-eks \
  --nodegroup-name budget-ng \
  --scaling-config minSize=2,maxSize=2,desiredSize=2 \
  --disk-size 20 \
  --subnets subnet-0393724a838283392 subnet-036ee587b6816bf88 \
  --instance-types t3.small \
  --ami-type AL2023_x86_64_STANDARD \
  --node-role arn:aws:iam::438465168997:role/EKSNodeInstanceRole \
  --region us-east-1
```

## 4.AWS Load Balancer Controller Setup on EKS

This document outlines the steps to install and configure the **AWS Load Balancer Controller** on an **EKS cluster**. The instructions include creating the necessary IAM policy, associating the IAM OIDC provider, and creating a service account.

---

## 5. Download the IAM Policy JSON

The AWS Load Balancer Controller requires a specific IAM policy. Download it using `curl`:

```bash
curl -o iam_policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json
```
## Explanation:
  -  -o iam_policy.json saves the file locally as iam_policy.json.
  -  The URL points to the official AWS Load Balancer Controller IAM policy.

## 6. Create the IAM Policy

- Use the downloaded JSON to create a new IAM policy in AWS:
```
aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam_policy.json
```
## Explanation:

  -   policy-name specifies the name of the IAM policy.

  -   policy-document points to the local JSON file you downloaded.

- This policy allows the controller to manage AWS resources like load balancers.

##  7. Associate IAM OIDC Provider with EKS Cluster

- Before creating the service account, associate the IAM OIDC provider with your cluster:

```
eksctl utils associate-iam-oidc-provider \
    --region us-east-1 \
    --cluster budget-eks \
    --approve
```

## Explanation:

-  Enables IAM roles for service accounts.

-  --approve automatically applies the changes.

-  Required to let Kubernetes service accounts assume IAM roles.

## 8. Create the IAM Service Account

- Create a Kubernetes service account with the IAM policy attached:

```
eksctl create iamserviceaccount \
    --cluster budget-eks \
    --namespace kube-system \
    --name aws-load-balancer-controller \
    --attach-policy-arn arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve \
    --region us-east-1
```
## Explanation:

- --cluster specifies the EKS cluster name.

- --namespace sets the namespace in Kubernetes (kube-system recommended).

- --attach-policy-arn links the IAM policy to the service account.

- --approve applies the changes immediately.

`Note: The arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy should match your AWS account ID.`

## 9. Verify the Cluster OIDC Issuer

- To ensure the OIDC provider is correctly associated, describe the EKS cluster:

```
aws eks describe-cluster \
    --name budget-eks \
    --region us-east-1 \
    --query "cluster.identity.oidc.issuer" \
    --output text
```

## Explanation:

 - Returns the OIDC issuer URL for your cluster.

 - Useful for debugging and verifying IAM role associations.

## 10. Optional: Re-run Service Account Creation (if needed)

- If you need to recreate or update the service account, you can run the same command again:
```
eksctl create iamserviceaccount \
    --cluster budget-eks \
    --namespace kube-system \
    --name aws-load-balancer-controller \
    --attach-policy-arn arn:aws:iam::438465168997:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve \
    --region us-east-1
```
